---
// src/pages/ostetaan-kultaa/[city].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import GoldCalculator from '../../components/react/GoldCalculator.tsx';
import { getGoldPrice } from '../../lib/api/metalPriceApi';
import { cities } from '../../data/cities';

// 1. Generoi polut kaikille kaupungeille (SSG)
export async function getStaticPaths() {
  return cities.map(city => ({
    params: { city: city.slug },
    props: { city }
  }));
}

// 2. M√§√§rit√§ kaupunki
const { city: citySlug } = Astro.params;
let { city } = Astro.props;

// Varmistus: Jos city-prop ei tullut l√§pi (esim. dev-tilassa), haetaan se manuaalisesti
if (!city && citySlug) {
  city = cities.find(c => c.slug === citySlug);
}

// Jos kaupunkia ei viel√§k√§√§n l√∂ydy (esim. v√§√§r√§ URL), ohjataan pois ettei sivu kaadu
if (!city) {
  return Astro.redirect('/404');
}

// 3. Hae hinnat (vain kerran!)
const goldPrice = await getGoldPrice();
const spot = goldPrice?.priceEurGram || 0;
const updatedAtFormatted = goldPrice 
  ? goldPrice.updatedAt.toLocaleString('fi-FI', { day: 'numeric', month: 'numeric' })
  : '';

// SEO-otsikot
const title = `Ostetaan kultaa ${city.name} ‚Äì Parhaat hinnat & ostajat 2025`;
const description = `Myy kultaa ${city.partitive}. Vertailimme ${city.genitive} luotettavimmat kullanostajat. Katso p√§iv√§n hinta ja l√∂yd√§ paras ostaja alueeltasi.`;

---

<BaseLayout 
  title={title} 
  description={description}
>

  <div class="relative bg-[#0B0F19] pt-32 pb-48 px-4 overflow-hidden">
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
       <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-gold-400/10 blur-[120px] rounded-full animate-blob"></div>
    </div>

    <div class="max-w-4xl mx-auto text-center relative z-10">
      
      <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-white/10 border border-white/10 backdrop-blur-md shadow-lg mb-8">
        <span class="relative flex h-2.5 w-2.5">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
        </span>
        <span class="text-white font-bold tracking-wide text-sm">
          P√§iv√§n hinta: {spot.toFixed(2)} ‚Ç¨/g
        </span>
      </div>

      <h1 class="text-4xl md:text-6xl font-black text-white mb-6 leading-tight">
        Kultaa rahaksi 
        <br />
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-gold-200 via-gold-400 to-gold-600">
          {city.partitive}
        </span>
      </h1>
      
      <p class="text-xl text-gray-400 max-w-2xl mx-auto mb-8 leading-relaxed">
        Etsitk√∂ luotettavaa kullanostajaa {city.partitive}? 
        Kilpailutimme alueen toimijat puolestasi.
      </p>

    </div>
  </div>

  <div class="relative z-20 -mt-24 px-4 pb-20">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-[2rem] shadow-[0_25px_50px_-12px_rgba(0,0,0,0.25)] border border-gray-100 overflow-hidden p-1 md:p-2">
        <GoldCalculator 
          client:visible 
          spotPriceEurPerGram={spot} 
          updatedAt={updatedAtFormatted} 
        />
      </div>
      <p class="text-center text-gray-500 text-sm mt-4">
        üí° Laske ensin arvio, jotta tied√§t mit√§ {city.genitive} liikkeiss√§ kannattaa pyyt√§√§.
      </p>
    </div>
  </div>

  <section class="py-16 bg-gray-50 border-t border-gray-100">
    <div class="max-w-5xl mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-black text-gray-900 mb-4">Luotettavat ostajat {city.partitive}</h2>
        <p class="text-gray-500">Olemme valinneet suositellut kumppanit asiakaspalautteiden ja hinnan perusteella.</p>
      </div>

      <div class="space-y-6">
        
        {city.partners.length > 0 ? (
          city.partners.map(partner => (
            <div class={`relative bg-white rounded-2xl p-6 md:p-8 transition-all hover:shadow-lg flex flex-col md:flex-row items-center gap-6 ${partner.tier === 'premium' ? 'border-2 border-gold-400 shadow-gold-400/10' : 'border border-gray-100'}`}>
              
              {partner.tier === 'premium' && (
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-gold-500 text-[#0B0F19] text-xs font-bold px-3 py-1 rounded-full shadow-sm">
                  {partner.badge || 'SUOSITELTU'}
                </div>
              )}

              <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center text-2xl border border-gray-100 shrink-0">
                üè¢
              </div>

              <div class="flex-1 text-center md:text-left">
                <h3 class="font-bold text-xl text-gray-900">{partner.name}</h3>
                <p class="text-gray-500 text-sm mb-2">{partner.address}, {city.name}</p>
                <div class="flex flex-wrap justify-center md:justify-start gap-2">
                  <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md border border-green-100">‚úÖ Tarkistettu toimija</span>
                  <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md border border-blue-100">üöÄ Nopea maksu</span>
                </div>
              </div>

              <div class="flex flex-col gap-3 w-full md:w-auto">
                <a href={partner.url} class="btn-cta text-sm px-6 py-3 min-w-[160px]">
                  Pyyd√§ tarjous
                </a>
                <a href={`tel:${partner.phone}`} class="text-center text-gray-500 text-sm hover:text-gold-600 font-medium">
                  üìû {partner.phone}
                </a>
              </div>
            </div>
          ))
        ) : (
          /* PLACEHOLDER: Jos kaupungissa ei ole viel√§ kumppaneita */
          <div class="bg-white rounded-2xl p-8 border-2 border-dashed border-gray-300 text-center">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Oletko kullanostaja {city.partitive}?</h3>
            <p class="text-gray-500 mb-6">T√§m√§ paikka on vapaana. Tavoita {city.genitive} myyj√§t ensimm√§isen√§.</p>
            <a href="/yrityksille" class="inline-flex items-center text-gold-600 font-bold hover:underline">
              Liity kumppaniksi &rarr;
            </a>
          </div>
        )}

        <div class="bg-[#0B0F19] rounded-2xl p-6 md:p-8 flex flex-col md:flex-row items-center gap-6 border border-gray-800 relative overflow-hidden">
           <div class="absolute top-0 right-0 w-32 h-32 bg-gold-500/10 rounded-full blur-2xl"></div>
           <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center text-2xl border border-white/10 shrink-0">
             üìÆ
           </div>
           <div class="flex-1 text-center md:text-left relative z-10">
             <div class="text-gold-400 text-xs font-bold uppercase tracking-wider mb-1">Toimii koko Suomessa</div>
             <h3 class="font-bold text-xl text-white">Verkkokulta Oy</h3>
             <p class="text-gray-400 text-sm">Etk√∂ p√§√§se liikkeeseen? Tilaa turvallinen postituspaketti kotiin.</p>
           </div>
           <a href="/yrityksille" class="bg-white text-[#0B0F19] font-bold px-6 py-3 rounded-xl hover:bg-gray-100 transition-colors relative z-10 min-w-[160px] text-center">
             Tilaa kuori
           </a>
        </div>

      </div>
    </div>
  </section>

  <section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4">
      <div class="prose prose-lg max-w-none text-gray-600">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Miten kullan myynti toimii {city.partitive}?</h2>
        <p>
          {city.description} Myyntiprosessi on suoraviivainen: otat mukaasi henkil√∂llisyystodistuksen, 
          marssit liikkeeseen ja saat arvion heti. Useimmat {city.genitive} liikkeet maksavat rahat tilille samana p√§iv√§n√§.
        </p>
        
        <h3 class="text-xl font-bold text-gray-900 mt-8 mb-4">Suosittuja kauppapaikkoja</h3>
        <p>
          Monet {city.genitive} kullanostajat ovat keskittyneet vilkkaiden katujen, kuten 
          <strong> {city.landmarks.slice(0, 2).join(' ja ')}</strong>, l√§heisyyteen. 
          My√∂s kauppakeskuksissa on usein ostopisteit√§.
        </p>

        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 mt-8 not-prose">
          <h4 class="font-bold text-blue-900 mb-2">üí° Vinkki {city.genitive} asukkaille</h4>
          <p class="text-blue-800 text-sm">
            Kilpailu {city.partitive} on kovaa. √Ñl√§ koskaan myy ensimm√§iseen paikkaan, vaan pyyd√§ tarjous 
            ainakin kahdelta yll√§ listatulta toimijalta. Hintaero voi olla kymmeni√§ euroja.
          </p>
        </div>
      </div>
    </div>
  </section>

</BaseLayout>